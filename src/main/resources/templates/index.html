<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản lý sinh viên</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body class="container mt-4">

<h3>DANH SÁCH SINH VIÊN</h3>

<div class="row mb-3">
    <div class="col-md-6">
        <input type="text" id="searchName" class="form-control"
               placeholder="Tìm theo tên..." onkeyup="searchStudent()">
    </div>
    <div class="col-md-6">
        <input type="number" id="searchId" class="form-control"
               placeholder="Tìm theo ID..." onkeyup="searchById()">
    </div>
</div>

<table class="table table-bordered">
    <thead>
    <tr>
        <th>ID</th>
        <th>Tên</th>
        <th>Email</th>
        <th>Hành động</th>
    </tr>
    </thead>
    <tbody id="studentTable"></tbody>
</table>

<h4 id="formTitle">Thêm sinh viên</h4>
<input type="hidden" id="studentId">
<input id="name" class="form-control mb-2" placeholder="Tên">
<input id="email" class="form-control mb-2" placeholder="Email">

<button id="submitBtn" class="btn btn-primary" onclick="saveStudent()">Thêm</button>
<button id="cancelBtn" class="btn btn-secondary" onclick="cancelEdit()" style="display:none;">Hủy</button>

<script>
const API = "https://lab3-production-1572.up.railway.app/api/students";

function loadStudents() {
    fetch(API)
        .then(res => res.json())
        .then(data => {
            let html = "";
            data.forEach(s => {
                html += `
                <tr>
                    <td>${s.id}</td>
                    <td>${s.name}</td>
                    <td>${s.email}</td>
                    <td>
                        <button class="btn btn-warning btn-sm"
                            onclick="editStudent(${s.id}, '${s.name}', '${s.email}')">Sửa</button>
                        <button class="btn btn-danger btn-sm"
                            onclick="deleteStudent(${s.id})">Xóa</button>
                    </td>
                </tr>`;
            });
            document.getElementById("studentTable").innerHTML = html;
        });
}

function saveStudent() {
    const id = document.getElementById("studentId").value;
    const student = {
        name: document.getElementById("name").value,
        email: document.getElementById("email").value
    };

    const url = id ? `${API}/update/${id}` : API;
    const method = "POST";

    fetch(url, {
        method: method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(student)
    }).then(() => {
        resetForm();
        loadStudents();
    });
}

function editStudent(id, name, email) {
    document.getElementById("studentId").value = id;
    document.getElementById("name").value = name;
    document.getElementById("email").value = email;
    document.getElementById("formTitle").textContent = "Cập nhật sinh viên";
    document.getElementById("submitBtn").textContent = "Cập nhật";
    document.getElementById("submitBtn").className = "btn btn-success";
    document.getElementById("cancelBtn").style.display = "inline-block";
}

function cancelEdit() {
    resetForm();
}

function resetForm() {
    document.getElementById("studentId").value = "";
    document.getElementById("name").value = "";
    document.getElementById("email").value = "";
    document.getElementById("formTitle").textContent = "Thêm sinh viên";
    document.getElementById("submitBtn").textContent = "Thêm";
    document.getElementById("submitBtn").className = "btn btn-primary";
    document.getElementById("cancelBtn").style.display = "none";
}

function deleteStudent(id) {
    fetch(`${API}/${id}`, { method: "DELETE" })
        .then(() => loadStudents());
}

function searchStudent() {
    const name = document.getElementById("searchName").value;
    document.getElementById("searchId").value = ""; // Clear ID search
    
    if (!name) {
        loadStudents();
        return;
    }
    
    fetch(`${API}/search?name=${name}`)
        .then(res => res.json())
        .then(data => {
            displaySearchResults(data);
        });
}

function searchById() {
    const id = document.getElementById("searchId").value;
    document.getElementById("searchName").value = ""; // Clear name search
    
    if (!id) {
        loadStudents();
        return;
    }
    
    fetch(`${API}/${id}`)
        .then(res => res.json())
        .then(data => {
            if (data && data.id) {
                displaySearchResults([data]);
            } else {
                document.getElementById("studentTable").innerHTML = 
                    '<tr><td colspan="4" class="text-center">Không tìm thấy sinh viên</td></tr>';
            }
        })
        .catch(() => {
            document.getElementById("studentTable").innerHTML = 
                '<tr><td colspan="4" class="text-center">Không tìm thấy sinh viên</td></tr>';
        });
}

function displaySearchResults(data) {
    let html = "";
    data.forEach(s => {
        html += `
        <tr>
            <td>${s.id}</td>
            <td>${s.name}</td>
            <td>${s.email}</td>
            <td>
                <button class="btn btn-warning btn-sm"
                    onclick="editStudent(${s.id}, '${s.name}', '${s.email}')">Sửa</button>
                <button class="btn btn-danger btn-sm"
                    onclick="deleteStudent(${s.id})">Xóa</button>
            </td>
        </tr>`;
    });
    document.getElementById("studentTable").innerHTML = html || 
        '<tr><td colspan="4" class="text-center">Không tìm thấy kết quả</td></tr>';
}

loadStudents();
</script>

</body>
</html>
